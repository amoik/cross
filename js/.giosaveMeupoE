var myApp;
myApp = myApp || (function ()
{
	var pleaseWaitDiv = $('<div class="modal" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false"><div class="modal-header"></div><div class="modal-body"><div class="progress progress-striped active" style="margin-top:30%;margin-left:20%;width:60%;"><div class="progress-bar" style="width: 100%;"></div></div></div></div>');
	return{
		showPleaseWait: function()
		{
			pleaseWaitDiv.modal();
		},
		hidePleaseWait: function ()
		{
			pleaseWaitDiv.modal('hide');
		},
	};
})();


angular.module('levelBuilder', []).controller('levelBuilderCtr', function($scope)
{
	var lvlC = this;
	lvlC.title = "Level Builder";
	lvlC.interface = "overview";
	lvlC.backendHost = BACKEND_HOST;

	lvlC.levelname = "NAME TODO";
	lvlC.entityChoosen = false;
	lvlC.backgrounds = [{id:"x0", name:"Holz"},{id:"x1", name:"Gras"},{id:"x2", name:"Stein"}];
	lvlC.entities = [{id:"bug", name:"KÃ¤fer"},{id:"enemy", name:"Gegner"}];
	lvlC.levels = [];
	lvlC.newLevel = {name: "",follow: ""};
	lvlC.loadedLevel = {};

	lvlC.rebuildLevelTable = function()
	{
		myApp.showPleaseWait();

		AJAXCall({function:"getLevels"},function(res)
		{
			lvlC.levels = res;
			$scope.$apply();
			myApp.hidePleaseWait();
		});
	}
	lvlC.rebuildLevelTable();




	lvlC.entity = {x:1.3,y:3.2, speed:4.3, angle: 34};




	lvlC.findFollowByName = function(name)
	{
		for(var i = 0; i < lvlC.levels.length; i++)
		{
			if(lvlC.levels[i].name == name)
			{
				return lvlC.levels[i].id;
			}
		}
		return false;
	}


	lvlC.setInterface = function(name)
	{
		lvlC.reInit();
		lvlC.interface = name;
	}

	lvlC.reInit = function()
	{
		lvlC.entityChoosen = false;
	}

	lvlC.removeLevel = function(lvl)
	{
		AJAXCall({function:"deleteLevel",id:lvl.id},function(res){lvlC.rebuildLevelTable();});
	}
	lvlC.openLevel = function(lvl)
	{
		lvlC.setInterface("detail");
		myApp.showPleaseWait();
		AJAXCall({function:"getLevelDetails",id:lvl.id},function(res)
		{
			lvlC.loadedLevel = res;
			$scope.$apply();
			myApp.hidePleaseWait();
		});
	}
	lvlC.saveLevel = function(lvl)
	{
		TODO();
	}

	lvlC.addBackground = function(bg)
	{
		reloadAll();
	}

	lvlC.addEntity = function(ent)
	{
		//TODO();
		if(lvlC.entityChoosen)
			lvlC.entityChoosen = false;
		else
			lvlC.entityChoosen = true;
	}

	lvlC.removeChoosenEntity = function()
	{
		if(lvlC.entityChoosen)
			lvlC.entityChoosen = false;
		else
			lvlC.entityChoosen = true;
	}

	lvlC.dlLevel = function(lvl)
	{
		window.location = BACKEND_HOST + "?function=dlLevel&id="+lvl.id;
	}

	lvlC.addNewLevel = function()
	{
		var lvlDetails = '{"backgrounds":["x0"],"enemies":[{"x":10,"y":-2,"a":176,"s":1,"v":0.20000000298023}],"goodies":[{"x":10,"y":4,"a":270,"s":1}]}';
		var lvlDetails = JSON.parse(lvlDetails);
		var fId = null;

		if(lvlC.newLevel.name.replace(/ /g,'') == "")
		{
			alert("Es muss ein Name angegeben werden!");
			return;
		}
		if(lvlC.newLevel.follow.replace(/ /g,'') !== "")
		{
			var fId = lvlC.findFollowByName(lvlC.newLevel.follow);
		}
		myApp.showPleaseWait();

		AJAXCall({function:"saveLevel",level:{name:lvlC.newLevel.name,follow:fId,details:lvlDetails}},function(res)
		{
			lvlC.rebuildLevelTable();
			lvlC.newLevel.name = "";
			lvlC.newLevel.follow = "";
		});
	}
});
